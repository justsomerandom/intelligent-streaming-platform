<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Live Stream Viewer</title>
        <style>
            body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
            video { border: 1px solid #ccc; background: black; }
            #metrics { margin-top: 20px; }
            select { padding: 6px; margin-bottom: 15px; }
        </style>
    </head>
    <body>
        <h2>Intelligent Camera Stream Viewer</h2>

        <label for="streamSelect">Select Camera:</label>
        <select id="streamSelect"></select>

        <br>
        <video id="videoStream" width="640" height="480" controls autoplay muted>
            <source id="videoSource" type="video/mp4">
            Your browser does not support the video tag.
        </video>

        <div id="metrics">
            <h3>Analytics Metrics</h3>
            <pre id="metricsDisplay">Loading...</pre>
        </div>

        <script>
            const streamSelect = document.getElementById("streamSelect");
            const video = document.getElementById("videoStream");
            const videoSource = document.getElementById("videoSource");
            const metricsDisplay = document.getElementById("metricsDisplay");

            async function updateStreamList() {
                try {
                    const res = await fetch("/api/streams/active");
                    const data = await res.json();
                    const streams = data.streams || [];

                    // Clear old options
                    streamSelect.innerHTML = "";
                    streams.forEach(name => {
                        const option = document.createElement("option");
                        option.value = name;
                        option.textContent = name;
                        streamSelect.appendChild(option);
                    });

                    if (streams.length > 0) {
                        const selected = streams[0];
                        videoSource.src = `http://localhost:8556/${selected}`;
                        video.load();
                    } else {
                        video.pause();
                    }
                } catch (err) {
                    console.error("Error fetching stream list", err);
                }
            }

            streamSelect.addEventListener("change", () => {
                const selected = streamSelect.value;
                videoSource.src = `http://localhost:8556/${selected}`;
                video.load();
            });

            async function fetchMetrics() {
                try {
                    const res = await fetch("/api/analytics/metrics");
                    const data = await res.json();
                    metricsDisplay.textContent = JSON.stringify(data, null, 2);
                } catch (err) {
                    metricsDisplay.textContent = "Error fetching metrics";
                }
            }

            // Initial load and refresh every 5s
            updateStreamList();
            setInterval(updateStreamList, 5000);
            setInterval(fetchMetrics, 2000);
            fetchMetrics();
        </script>
    </body>
</html>
